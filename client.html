<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>WebSocket</title>
  </head>
  <body>
    <input id="url" type="text" size="30" value="ws://localhost:15368" />
    <button onclick="openWebSocket()">打开WebSocket连接</button>
    <button onclick="closeWebSocket()">关闭WebSocket连接</button>
    <hr />
    <div>
      <textarea id="text" type="text"></textarea>
      <br />
      <button onclick="send()">发送消息</button>
      <button onclick="testText()">预览消息</button>
      <button onclick="clearMsg()">清屏</button>
    </div>
    <hr />
    <div>
      <button onclick="reqLogin()">登录</button>
      <button onclick="reqLiveList()">查询直播间列表</button>
      <button onclick="reqLiveRecord()">查询直播记录</button>
    </div>

    <hr />
    <div id="message"></div>
  </body>
  <script type="text/javascript">
    function reqLogin() {
      let req = {
        "type": 2,
        "requestID": "reqLogin",
        "data": {
          "account": "填入手机号或邮箱",
          "password": "填入密码"
        }
      };
      var message = JSON.stringify(req);
      websocket.send(message);
    }

    //请求直播间列表
    function reqLiveList() {
      let req = {
        "type": 110,
        "requestID": "reqLiveList"
      };
      let message = JSON.stringify(req);
      websocket.send(message);
    }

    //获取直播统计数据 days:天数
    function reqLiveRecord() {
      let req = {
        "type": 112,
        "requestID": "reqLiveRecord",
        "data": {
          "days": 30
        }
      };
      let message = JSON.stringify(req);
      websocket.send(message);
    }

    //清屏
    function clearMsg() {
      document.getElementById('message').innerHTML = "";
    }

    var websocket = null;

    function openWebSocket() {
      var url = document.getElementById('url').value.trim();
      //判断当前浏览器是否支持WebSocket
      if ('WebSocket' in window) {
        websocket = new WebSocket(url);
      } else {
        alert('当前浏览器 Not support websocket')
      }
      //连接发生错误的回调方法
      websocket.onerror = function() {
        setMessageInnerHTML("WebSocket连接发生错误");
      };
      //连接成功建立的回调方法
      websocket.onopen = function() {
        setMessageInnerHTML("WebSocket连接成功");
      }
      //接收到消息的回调方法
      websocket.onmessage = function(event) {
        setMessageInnerHTML(event.data);
      }
      //连接关闭的回调方法
      websocket.onclose = function() {
        setMessageInnerHTML("WebSocket连接关闭");
      }
    }
    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function() {
      closeWebSocket();
    }
    //将消息显示在网页上
    function setMessageInnerHTML(innerHTML) {
      document.getElementById('message').innerHTML += '<p>' + innerHTML + '</p>';
    }
    //关闭WebSocket连接
    function closeWebSocket() {
      websocket.close();
    }
    //发送消息
    function send() {
      var message = document.getElementById('text').value;
      message = clearBr(message);
      message = CTim(message);
      websocket.send(message);
    }
    //预览消息
    function testText() {
      var message = document.getElementById('text').value;
      message = clearBr(message);
      message = CTim(message);
      console.log(JSON.stringify(message));
    }

    function clearBr(key) {
      key = key.replace(/<\/?.+?>/g, "");
      key = key.replace(/[\r\n]/g, "");
      return key;
    }

    function CTim(str) {
      return str.replace(/\s/g, '');
    }
  </script>
</html>
